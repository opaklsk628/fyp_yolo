<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Monitoring - Heatstroke Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        
        /* alert  banner */
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            background-color: #dc3545;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            animation: pulse 1s ease-in-out infinite;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .alert-banner.active {
            display: block;
        }
        
        /* Push content down when alert is active */
        body.alert-active {
            padding-top: 70px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .navbar {
            background-color: #333;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .navbar.alert {
            background-color: #dc3545;
        }
        .navbar h1 {
            margin: 0;
            font-size: 24px;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .navbar a:hover {
            background-color: #555;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 20px;
            text-align: center;
        }
        
        .monitoring-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Weather widget integrated into monitoring section */
        .weather-info-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .weather-info-bar .location {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .weather-info-bar .temp {
            font-size: 28px;
            font-weight: bold;
        }
        
        .weather-info-bar .humidity {
            font-size: 16px;
        }
        
        .weather-warnings-info {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .video-container {
            margin: 20px auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            display: inline-block;
            position: relative;
            max-width: 960px; /* Fixed maximum width.... */
            width: 100%;
        }
        
        /* Fixed aspect ratio container */
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            background-color: #000;
        }
        
        .video-wrapper img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Maintain aspect ratio */
        }
        
        .resolution-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 5px;
        }
        .resolution-controls select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .stats-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-box {
            background-color: #f8f9fa;
            padding: 20px 30px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-width: 150px;
        }
        .stat-box h3 {
            margin: 0;
            color: #495057;
            font-size: 16px;
            font-weight: normal;
        }
        .stat-box .value {
            font-size: 36px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        #fall_alert {
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 600px;
            font-size: 20px;
            font-weight: bold;
            border: 1px solid #f5c6cb;
            animation: pulse 1s ease-in-out infinite;
        }
        .camera-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .camera-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .camera-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .admin-controls {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .admin-controls h3 {
            margin-top: 0;
            color: #495057;
        }
        .admin-controls button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-restart {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-restart:hover {
            background-color: #e0a800;
        }
        .btn-stop {
            background-color: #dc3545;
            color: white;
        }
        .btn-stop:hover {
            background-color: #c82333;
        }
        
        .network-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
        }
        
        /* Fall records section with proper table */
        .fall-records-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .fall-records-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-view-all {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .btn-view-all:hover {
            background-color: #0056b3;
        }
        
        /* Proper table styling with grid lines */
        .fall-records-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            border: 1px solid #dee2e6;
        }
        
        .fall-records-table th {
            background-color: #007bff;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: normal;
            border: 1px solid #0056b3;
        }
        
        .fall-records-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
            background-color: white;
        }
        
        .fall-records-table tr:nth-child(even) td {
            background-color: #f8f9fa;
        }
        
        .fall-records-table tr:hover td {
            background-color: #e9ecef;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .no-records {
            text-align: center;
            color: #6c757d;
            padding: 20px;
            font-style: italic;
        }
        
        .fall-count {
            background-color: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .location-info {
            background-color: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Full-width alert banner -->
    <div class="alert-banner" id="alertBanner">
        ‚ö†Ô∏è WARNING: Fall Detected! Please check immediately!
    </div>

    <div class="navbar" id="navbar">
        <h1>Real-time Posture Detection</h1>
        <div>
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('monitor') }}">Monitor</a>
            <a href="{{ url_for('fall_records') }}">Fall Detection History</a>
            {% if current_user.is_admin %}
            <a href="{{ url_for('settings') }}">Settings</a>
            {% endif %}
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="monitoring-section">
            <!-- Weather info bar -->
            <div class="weather-info-bar">
                <div class="location">Hong Kong</div>
                {% if weather and weather.current %}
                <div class="temp">{{ weather.current.temperature }}¬∞C</div>
                <div class="humidity">üíß Humidity: {{ weather.current.humidity }}%</div>
                {% else %}
                <div class="temp">Loading weather...</div>
                {% endif %}
                
                {% if weather and weather.warnings and weather.warnings|length > 0 %}
                <div class="weather-warnings-info">
                    ‚ö†Ô∏è {{ weather.warnings|length }} weather warning(s) in effect
                </div>
                {% endif %}
            </div>
            
            <h2>Real-time Monitoring (Heatstroke Detection)</h2>
            
            <div class="location-info">
                <strong>Camera Location:</strong> {{ camera_location }}
            </div>
            
            <div id="camera_status" class="camera-status camera-connected">
                Camera: Connected
            </div>

            <div class="video-container">
                <div class="resolution-controls">
                    <select id="resolutionSelect" onchange="changeResolution()">
                        <option value="240p" {% if current_resolution == '240p' %}selected{% endif %}>240p (Ultra Low)</option>
                        <option value="360p" {% if current_resolution == '360p' %}selected{% endif %}>360p (Low)</option>
                        <option value="480p" {% if current_resolution == '480p' %}selected{% endif %}>480p (Medium)</option>
                        <option value="720p" {% if current_resolution == '720p' %}selected{% endif %}>720p (High)</option>
                        <option value="1080p" {% if current_resolution == '1080p' %}selected{% endif %}>1080p (Ultra High)</option>
                    </select>
                </div>
                <div class="video-wrapper">
                    <img src="{{ url_for('video_feed') }}" alt="Live Video Feed" id="videoFeed">
                </div>
            </div>
            
            <div class="network-info" id="networkInfo">
                Current Resolution: <span id="currentRes">{{ current_resolution }}</span> | 
                FPS: <span id="currentFPS">30</span> | 
                Bandwidth Usage: <span id="bandwidth">~800KB/s</span>
            </div>

            <div class="stats-container">
                <div class="stat-box">
                    <h3>Standing/Sitting</h3>
                    <div class="value" id="standing_sitting">0</div>
                </div>
                <div class="stat-box">
                    <h3>Lying Down</h3>
                    <div class="value" id="lying_down">0</div>
                </div>
            </div>

            <div id="fall_alert" style="display:none;">
                ‚ö†Ô∏è WARNING: Fall Detected!
            </div>

            {% if current_user.is_admin %}
            <div class="admin-controls">
                <h3>System Controls (Admin Only)</h3>
                <button class="btn-restart" onclick="restartSystem()">üîÑ Restart System</button>
                <button class="btn-stop" onclick="stopSystem()">‚èπÔ∏è Stop System</button>
            </div>
            {% endif %}
        </div>

        <!-- Fall Records Section with Proper Table -->
        <div class="fall-records-section">
            <h3>
                <span>Recent Fall Records <span id="fallCount" class="fall-count" style="display:none;">0</span></span>
                <a href="{{ url_for('fall_records') }}" class="btn-view-all">View All Records</a>
            </h3>
            <div id="fallRecordsList">
                <table class="fall-records-table" id="fallTable">
                    <thead>
                        <tr>
                            <th width="15%">Time</th>
                            <th width="20%">Date</th>
                            <th width="35%">Location</th>
                            <th width="20%">Lying Down Count</th>
                            {% if current_user.is_admin %}
                            <th width="10%">Action</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="fallTableBody">
                        {% if recent_falls %}
                            {% for fall in recent_falls %}
                            <tr data-record-id="{{ fall.id }}">
                                <td>{{ fall.hk_detection_time.strftime('%H:%M:%S') }}</td>
                                <td>{{ fall.hk_detection_time.strftime('%Y-%m-%d') }}</td>
                                <td>{{ camera_location }}</td>
                                <td>{{ fall.lying_down_count }}</td>
                                {% if current_user.is_admin %}
                                <td>
                                    <button class="delete-btn" onclick="deleteFallRecord({{ fall.id }})">Delete</button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr class="no-records-row">
                                <td colspan="{% if current_user.is_admin %}5{% else %}4{% endif %}" class="no-records">
                                    No fall records in recent history
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    let notificationPermission = false;
    let lastFallDetected = false;
    let isAdmin = {{ 'true' if current_user.is_admin else 'false' }};

    // Request notification permission
    if ("Notification" in window) {
        if (Notification.permission === "granted") {
            notificationPermission = true;
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(function (permission) {
                if (permission === "granted") {
                    notificationPermission = true;
                }
            });
        }
    }

    function showNotification(title, body) {
        if (notificationPermission) {
            new Notification(title, {
                body: body,
                icon: '/static/warning.png',
                requireInteraction: true
            });
        }
    }

    function updateAlertUI(fallDetected) {
        const navbar = document.getElementById('navbar');
        const fallAlert = document.getElementById('fall_alert');
        const alertBanner = document.getElementById('alertBanner');
        const body = document.body;
        
        if (fallDetected && !lastFallDetected) {
            // Show alerts
            navbar.classList.add('alert');
            fallAlert.style.display = 'block';
            alertBanner.classList.add('active');
            body.classList.add('alert-active');
            document.title = "‚ö†Ô∏è Fall Alert - Heatstroke Detection";
            
            // Show browser notification
            showNotification("‚ö†Ô∏è Fall Detected!", "Someone has fallen down. Please check immediately!");
            
            // Play alert sound if available
            try {
                const audio = new Audio('/static/alert.mp3');
                audio.play();
            } catch (e) {
                console.log("Could not play alert sound");
            }
            
            // Reload fall records
            updateFallRecords();
        } else if (!fallDetected && lastFallDetected) {
            // Hide alerts
            navbar.classList.remove('alert');
            fallAlert.style.display = 'none';
            alertBanner.classList.remove('active');
            body.classList.remove('alert-active');
            document.title = "Real-time Monitoring - Heatstroke Detection";
        }
        
        lastFallDetected = fallDetected;
    }

    function changeResolution() {
        const select = document.getElementById('resolutionSelect');
        const resolution = select.value;
        
        console.log('Changing resolution to:', resolution);
        
        fetch('/set_resolution', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({ resolution: resolution })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                document.getElementById('currentRes').textContent = resolution;
                
                // Update bandwidth info
                const resolutions = {
                    '240p': { bandwidth: '~100KB/s', fps: '10' },
                    '360p': { bandwidth: '~200KB/s', fps: '10' },
                    '480p': { bandwidth: '~400KB/s', fps: '15' },
                    '720p': { bandwidth: '~800KB/s', fps: '20' },
                    '1080p': { bandwidth: '~1.5MB/s', fps: '20' }
                };
                
                const res = resolutions[resolution];
                document.getElementById('bandwidth').textContent = res.bandwidth;
                document.getElementById('currentFPS').textContent = res.fps;
                
                // Force reload video feed
                const videoFeed = document.getElementById('videoFeed');
                const currentSrc = videoFeed.src;
                videoFeed.src = '';
                setTimeout(() => {
                    videoFeed.src = currentSrc;
                }, 100);
            }
        })
        .catch(error => {
            console.error('Error changing resolution:', error);
        });
    }

    function deleteFallRecord(recordId) {
        if (!confirm('Are you sure you want to delete this record?')) {
            return;
        }

        fetch(`/api/fall_records/${recordId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from table
                const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
                if (row) {
                    row.remove();
                    updateFallCount();
                }
            } else {
                alert('Failed to delete record: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting record:', error);
            alert('Error deleting record');
        });
    }

    function updateFallRecords() {
        fetch('/api/recent_falls')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById('fallTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.falls.length > 0) {
                        data.falls.forEach(fall => {
                            const row = document.createElement('tr');
                            row.setAttribute('data-record-id', fall.id);
                            row.innerHTML = `
                                <td>${fall.time}</td>
                                <td>${fall.date}</td>
                                <td>${fall.camera_location}</td>
                                <td>${fall.lying_down_count}</td>
                                ${isAdmin ? `<td><button class="delete-btn" onclick="deleteFallRecord(${fall.id})">Delete</button></td>` : ''}
                            `;
                            tbody.appendChild(row);
                        });
                        
                        updateFallCount();
                    } else {
                        tbody.innerHTML = `
                            <tr class="no-records-row">
                                <td colspan="${isAdmin ? '5' : '4'}" class="no-records">
                                    No fall records in recent history
                                </td>
                            </tr>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching fall records:', error);
            });
    }

    function updateFallCount() {
        const rows = document.querySelectorAll('#fallTableBody tr:not(.no-records-row)');
        const count = rows.length;
        const fallCount = document.getElementById('fallCount');
        
        if (count > 0) {
            fallCount.textContent = count;
            fallCount.style.display = 'inline-block';
        } else {
            fallCount.style.display = 'none';
        }
    }

    // Admin control functions
    function restartSystem() {
        if (confirm('Are you sure you want to restart the monitoring system?')) {
            fetch('/api/system/restart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('System restart initiated');
                } else {
                    alert('Failed to restart system: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    }

    function stopSystem() {
        if (confirm('Are you sure you want to stop the monitoring system? This will shut down the service.')) {
            fetch('/api/system/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('System shutdown initiated');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    alert('Failed to stop system: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    }

    // Update counts periodically
    setInterval(function() {
        fetch('/counts')
            .then(response => response.json())
            .then(data => {
                document.getElementById('standing_sitting').innerText = data.standing_sitting;
                document.getElementById('lying_down').innerText = data.lying_down;
                
                // Update fall alert
                updateAlertUI(data.fall_detected);
                
                // Update camera status
                const cameraStatus = document.getElementById('camera_status');
                if (data.camera_connected) {
                    cameraStatus.className = 'camera-status camera-connected';
                    cameraStatus.innerText = 'Camera: Connected';
                } else {
                    cameraStatus.className = 'camera-status camera-disconnected';
                    cameraStatus.innerText = 'Camera: Disconnected';
                }
            })
            .catch(error => {
                console.error('Error fetching counts:', error);
                // Show disconnected status on error
                const cameraStatus = document.getElementById('camera_status');
                cameraStatus.className = 'camera-status camera-disconnected';
                cameraStatus.innerText = 'Server: Disconnected';
            });
    }, 1000);
    
    // Update fall records every 10 seconds
    setInterval(updateFallRecords, 10000);
    
    // Update weather every 5 minutes
    function updateWeather() {
        fetch('/api/weather')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    // Update weather info bar
                    const weatherBar = document.querySelector('.weather-info-bar');
                    if (data.data.current && weatherBar) {
                        const tempElement = weatherBar.querySelector('.temp');
                        const humidityElement = weatherBar.querySelector('.humidity');
                        
                        if (tempElement) {
                            tempElement.innerHTML = `${data.data.current.temperature}¬∞C`;
                        }
                        if (humidityElement) {
                            humidityElement.innerHTML = `üíß Humidity: ${data.data.current.humidity}%`;
                        }
                    }
                    
                    if (data.data.warnings && data.data.warnings.length > 0) {
                        const warningsDiv = weatherBar.querySelector('.weather-warnings-info');
                        if (warningsDiv) {
                            warningsDiv.innerHTML = `‚ö†Ô∏è ${data.data.warnings.length} weather warning(s) in effect`;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching weather:', error);
            });
    }
    
    // Initial setup
    updateFallCount();
    updateWeather();
    setInterval(updateWeather, 300000); // 5 minutes
    
    // Set initial resolution info
    const currentResolution = '{{ current_resolution }}';
    const resolutions = {
        '240p': { bandwidth: '~100KB/s', fps: '10' },
        '360p': { bandwidth: '~200KB/s', fps: '10' },
        '480p': { bandwidth: '~400KB/s', fps: '15' },
        '720p': { bandwidth: '~800KB/s', fps: '20' },
        '1080p': { bandwidth: '~1.5MB/s', fps: '20' }
    };
    
    if (resolutions[currentResolution]) {
        const res = resolutions[currentResolution];
        document.getElementById('bandwidth').textContent = res.bandwidth;
        document.getElementById('currentFPS').textContent = res.fps;
    }
    </script>
</body>
</html>


